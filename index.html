<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Sonar Bleep with MIDI</title>
  <style>
    /* Previous styles remain the same */
    
    /* Add these new styles for the compass */
    #compass {
      width: 150px;
      height: 150px;
      margin: 20px auto;
      position: relative;
    }
    #compass-circle {
      width: 100%;
      height: 100%;
      border: 3px solid #0f0;
      border-radius: 50%;
      position: relative;
    }
    #compass-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50%;
      height: 4px;
      background: #f00;
      transform-origin: left center;
      transform: rotate(0deg) translateX(0);
      transition: transform 0.5s ease-out;
    }
    #compass-arrow:after {
      content: '';
      position: absolute;
      right: -10px;
      top: -8px;
      width: 0;
      height: 0;
      border-left: 10px solid #f00;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
    }
    #compass-label {
      position: absolute;
      bottom: -25px;
      width: 100%;
      text-align: center;
      color: #0f0;
    }
    .north-mark {
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      color: #0f0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Previous HTML remains the same until just before the debug div -->

  <div class="panel">
    <h2>Compass</h2>
    <div id="compass">
      <div id="compass-circle">
        <div class="north-mark">N</div>
        <div id="compass-arrow"></div>
      </div>
      <div id="compass-label">Pointing to locked position</div>
    </div>
  </div>

  <div id="debug"></div>

  <script>
    // Previous JavaScript remains the same until the SonarBleep object

    const SonarBleep = {
      // All previous properties remain the same
      
      // Add this new method to update the compass
      updateCompass: function(currentLat, currentLon) {
        if (!this.lockPosition) return;
        
        // Calculate bearing from current position to locked position
        const y = Math.sin(this.lockPosition.lon - currentLon) * Math.cos(this.lockPosition.lat);
        const x = Math.cos(currentLat) * Math.sin(this.lockPosition.lat) - 
                 Math.sin(currentLat) * Math.cos(this.lockPosition.lat) * 
                 Math.cos(this.lockPosition.lon - currentLon);
        let bearing = Math.atan2(y, x);
        bearing = (bearing * 180 / Math.PI + 360) % 360; // Convert to degrees and normalize
        
        // Update compass arrow
        const arrow = document.getElementById('compass-arrow');
        arrow.style.transform = `rotate(${bearing}deg) translateX(0)`;
        
        // Update debug info
        this.log(`Compass bearing: ${bearing.toFixed(1)}Â°`);
      },

      // Modify the handlePositionUpdate method to include compass updates
      handlePositionUpdate: function(pos) {
        const now = Date.now();
        this.lastUpdateTime = now;
        
        if (!this.lockPosition || !this.isActive) return;

        const { latitude, longitude, accuracy, speed } = pos.coords;
        const distance = this.calculateDistance(latitude, longitude, this.lockPosition.lat, this.lockPosition.lon);
        
        // Store movement data for smoothing
        this.movementHistory.push({
          time: now,
          distance,
          speed: speed || 0
        });
        
        // Keep only recent history (last 3 seconds)
        this.movementHistory = this.movementHistory.filter(item => now - item.time < 3000);
        
        this.updateDisplay(distance, accuracy, speed);
        this.updateAudioAndMIDI(distance);
        this.updateCompass(latitude * Math.PI/180, longitude * Math.PI/180); // Convert to radians
      },

      // All other methods remain the same
    };

    // Rest of the JavaScript remains the same
  </script>
</body>
</html>
